// SPDX-License-Identifier: MIT
// solhint-disable max-line-length
pragma solidity >=0.8.18;

import { IPRBProxyAnnex } from "../../src/interfaces/IPRBProxyAnnex.sol";
import { IPRBProxyRegistry } from "../../src/interfaces/IPRBProxyRegistry.sol";

/// @notice This is useful for external integrations seeking to test against the exact deployed bytecode, as recompiling
/// with via IR enabled would be time-consuming.
contract Precompiles {
    /*//////////////////////////////////////////////////////////////////////////
                                     BYTECODES
    //////////////////////////////////////////////////////////////////////////*/

    bytes public constant BYTECODE_ANNEX =
        hex"6080806040523461001657610526908161001c8239f35b600080fdfe6080604081815260048036101561001557600080fd5b600092833560e01c9081631f9838b5146103ba5750806338a40908146103795780634bddd93a146102a3578063aa4b826a14610213578063b96784031461010a5763ffa1ad741461006557600080fd5b346101065782600319360112610106578151908282019082821067ffffffffffffffff8311176100f357508252600c81526020906b342e302e302d626574612e3560a01b8282015282519382859384528251928382860152825b8481106100dd57505050828201840152601f01601f19168101030190f35b81810183015188820188015287955082016100bf565b634e487b7160e01b855260419052602484fd5b8280fd5b5034610106576020918260031936011261020f5781356001600160a01b038116939084900361020b57815163ecdb286560e01b81528581858183895af19081156102015786916101df575b5080519384156101c85750855b8481106101925786867f88b2a910c369b31905e184140cbb1e5ec72817e11c4d6c5993f736716f8546598280a280f35b6001906001600160e01b03196101a882856104fc565b5116885287845284882080546001600160a01b0319168817905501610162565b835163b702f33560e01b8152908101869052602490fd5b6101fb91503d8088833e6101f38183610437565b81019061046f565b38610155565b83513d88823e3d90fd5b8480fd5b8380fd5b50503461029f57606036600319011261029f5761022e610406565b610236610421565b916044359081151580920361020b577f730824739164a9503317b3e878e816553b62d6763c1ba6df1390dea687e4d36c9160209160018060a01b038095169485885260018452818820961695868852835280872060ff1981541660ff841617905551908152a380f35b5080fd5b5034610106576020918260031936011261020f5781356001600160a01b038116939084900361020b57815163ecdb286560e01b81528581858183895af190811561020157869161035f575b5080519384156101c85750855b84811061032b5786867f7207021e3ba5dd0d191feb5efcbb1a8dcf615fa597fc5e1a49ecc13c2b7dd92b8280a280f35b6001906001600160e01b031961034182856104fc565b5116885287845284882080546001600160a01b0319169055016102fb565b61037391503d8088833e6101f38183610437565b386102ee565b5034610106576020366003190112610106573563ffffffff60e01b81168091036101065782526020828152918190205490516001600160a01b039091168152f35b8490843461010657806003193601126101065760ff906020936103db610406565b6103e3610421565b6001600160a01b0391821683526001875283832091168252855220541615158152f35b600435906001600160a01b038216820361041c57565b600080fd5b602435906001600160a01b038216820361041c57565b90601f8019910116810190811067ffffffffffffffff82111761045957604052565b634e487b7160e01b600052604160045260246000fd5b90602090818382031261041c57825167ffffffffffffffff9384821161041c570181601f8201121561041c578051938411610459578360051b90604051946104b985840187610437565b8552838086019282010192831161041c578301905b8282106104dc575050505090565b81516001600160e01b03198116810361041c5781529083019083016104ce565b80518210156105105760209160051b010190565b634e487b7160e01b600052603260045260246000fd";

    bytes public constant BYTECODE_REGISTRY =
        hex"60808060405234610016576112fe908161001c8239f35b600080fdfe60808060405260043610156200001457600080fd5b60003560e01c908163092af813146200035e575080632c27a01f146200032057806366b0182d146200022057806374912cd214620001ab578063775c300c1462000137578063c455279114620000f85763ffa1ad74146200007457600080fd5b34620000f3576000366003190112620000f357604051604081019080821067ffffffffffffffff831117620000dd57620000d991604052600c81526b342e302e302d626574612e3560a01b602082015260405191829160208352602083019062000797565b0390f35b634e487b7160e01b600052604160045260246000fd5b600080fd5b34620000f3576020366003190112620000f35760206001600160a01b03806200012062000720565b166000526004825260406000205416604051908152f35b34620000f3576000366003190112620000f357336000908152600460205260409020546001600160a01b0390811680620001825760208262000179336200086b565b60405191168152f35b6040516356352f0b60e11b81523360048201526001600160a01b03919091166024820152604490fd5b34620000f3576020366003190112620000f357620001c862000720565b60018060a01b03908181166000526004602052816040600020541680620001f75760208362000179846200086b565b6040516356352f0b60e11b81526001600160a01b03928316600482015291166024820152604490fd5b34620000f3576000366003190112620000f35760018060a01b0380600054166001918254169160405190600090600254906200025c8262000737565b80855291818116908115620002f75750600114620002a9575b5050906200028a81620000d993038262000774565b6040519384938452602084015260606040840152606083019062000797565b600260009081529250600080516020620012de8339815191525b828410620002de5750505081016020016200028a8262000275565b80546020858701810191909152909301928101620002c3565b60ff191660208087019190915292151560051b850190920192506200028a915083905062000275565b34620000f3576020366003190112620000f3576001600160a01b036200034562000720565b1660005260036020526020604060002054604051908152f35b34620000f3576040366003190112620000f3576200037b62000720565b6024359167ffffffffffffffff8311620000f35736602384011215620000f35782600401359067ffffffffffffffff8211620000f3573660248386010111620000f357336000908152600460205260409020546001600160a01b031680620006fd57505032600081815260036020908152604091829020548251918201938452918101829052909291906200041e81606081015b03601f19810183528262000774565b5190209260405191606083019083821067ffffffffffffffff831117620000dd5760009260209260405233855260018060a01b031682850152806024604051986200047385601f19601f860116018b62000774565b828a52018389013786010152604081018490528051600080546001600160a01b03199081166001600160a01b0393841617909155602090920151600180549093169116178155835190919067ffffffffffffffff8111620000dd57620004db60025462000737565b601f811162000685575b50602094601f82116001146200060f5794819293949560009262000603575b5050600019600383901b1c191690831b176002555b60405161093d908181019181831067ffffffffffffffff841117620000dd5785928291620009a1833903906000f5928315620005f7576020936001600160a01b03169262000566620007d9565b33600052600485526040600020846bffffffffffffffffffffffff60a01b82541617905532600052600385528201604060002055604051917f6aafca263a35a9d2a6e4e4659a84688092f4ae153df2f95cd7659508d95c1870339380620005ec8733963296849192604091949360608401958452602084015260018060a01b0316910152565b0390a4604051908152f35b6040513d6000823e3d90fd5b01519050858062000504565b601f198216956002600052600080516020620012de8339815191529160005b8881106200066e5750838697989695961062000654575b505050811b0160025562000519565b015160001960f88460031b161c1916905585808062000645565b81830151845592860192602092830192016200062e565b6002600052601f820160051c600080516020620012de833981519152019060208310620006e5575b601f85910160051c600080516020620012de83398151915201915b828110620006d8575050620004e5565b60008155018490620006c8565b600080516020620012de8339815191529150620006ad565b6356352f0b60e11b82523360048301526001600160a01b03166024820152604490fd5b600435906001600160a01b0382168203620000f357565b90600182811c9216801562000769575b60208310146200075357565b634e487b7160e01b600052602260045260246000fd5b91607f169162000747565b90601f8019910116810190811067ffffffffffffffff821117620000dd57604052565b919082519283825260005b848110620007c4575050826000602080949584010152601f8019910116010190565b602081830181015184830182015201620007a2565b60008080556001818155620007f060025462000737565b9081620007fc57505050565b601f82116001146200080f575050600255565b60028352601f600080516020620012de833981519152920160051c82017f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5acf5b81811062000860575050508160025555565b84815582016200084e565b3260008181526003602090815260408083205481519283019485528282018190529495949293909291620008a381606081016200040f565b5190209160018060a01b03809616936bffffffffffffffffffffffff60a01b968588835416178255825161093d8082019082821067ffffffffffffffff8311176200098c579180918893620009a18339039084f58015620009825716967f6aafca263a35a9d2a6e4e4659a84688092f4ae153df2f95cd7659508d95c18709291906200092e620007d9565b868252600460205288838320918254161790553281526003602052816001850191205551806200097d8833963296849192604091949360608401958452602084015260018060a01b0316910152565b0390a4565b83513d84823e3d90fd5b634e487b7160e01b85526041600452602485fdfe60c08060405234620000b5573360a0526366b0182d60e01b8152600081600481335afa8015620000af5760008092819262000086575b506080526001600160a01b03821662000072575b6040516105ef90816200034e823960805181818161025b0152610467015260a051816102160152f35b6200007d916200029d565b50388062000049565b909150620000a692503d8092823e6200009f82620000d0565b0162000179565b90913862000035565b6200020c565b600080fd5b634e487b7160e01b600052604160045260246000fd5b60c0601f91909101601f19168101906001600160401b03821190821017620000f757604052565b620000ba565b601f909101601f19168101906001600160401b03821190821017620000f757604052565b60e051906001600160a01b0382168203620000b557565b6001600160401b038111620000f757601f01601f191660200190565b60005b838110620001685750506000910152565b818101518382015260200162000157565b606060bf19820112620000b55760c0516001600160a01b0381168103620000b55791620001a562000121565b610100519092906001600160401b038111620000b5578160df82011215620000b5578060c00151620001d78162000138565b92620001e76040519485620000fd565b81845260e08284010111620000b557620002099160e060208501910162000154565b90565b6040513d6000823e3d90fd5b3d1562000248573d906200022c8262000138565b916200023c6040519384620000fd565b82523d6000602084013e565b606090565b90602091620002688151809281855285808601910162000154565b601f01601f1916010190565b90916200028e62000209936040845260408401906200024d565b9160208184039101526200024d565b9190823b156200032c57600080825160208401865af4907fb24ebe141c5f2a744b103bea65fce6c40e0dc65d7341d092c09b160f40447990620002df62000218565b60405190956001600160a01b0316928190620002fe9088908362000274565b0390a2156200030957565b508051156200031a57602081519101fd5b60405163061a160d60e41b8152600490fd5b604051636d17e5ef60e11b81526001600160a01b0384166004820152602490fdfe60806040526004361015610027575b36156100255761001d3661035c565b602081519101f35b005b6000803560e01c9081631cff79cd1461007a575080631f9838b51461007557806338a40908146100705780637b1039991461006b57638da5cb5b0361000e57610245565b610200565b6101bb565b610158565b60403660031901126100e65761008e6100e9565b60243567ffffffffffffffff928382116100e657366023830112156100e65781600401359384116100e65736602485840101116100e6576100e26100d685602485018661045a565b60405191829182610144565b0390f35b80fd5b600435906001600160a01b03821682036100ff57565b600080fd5b919082519283825260005b848110610130575050826000602080949584010152601f8019910116010190565b60208183018101518483018201520161010f565b906020610155928181520190610104565b90565b346100ff5760403660031901126100ff576101716100e9565b602435906001600160a01b039081831683036100ff571660009081526001602090815260408083206001600160a01b03909416835292815291902060ff9054166040519015158152f35b346100ff5760203660031901126100ff5760043563ffffffff60e01b81168091036100ff576000526000602052602060018060a01b0360406000205416604051908152f35b346100ff5760003660031901126100ff576040517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b346100ff5760003660031901126100ff576040517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b908160008237016000815290565b634e487b7160e01b600052604160045260246000fd5b6040519190601f01601f1916820167ffffffffffffffff8111838210176102d457604052565b610298565b67ffffffffffffffff81116102d457601f01601f191660200190565b3d1561031b573d9061030e610309836102d9565b6102ae565b9182523d6000602084013e565b606090565b606090610155939260408252806040830152806000848401376000838284010152601f8019910116810190602083828403019101520190610104565b600080356001600160e01b0319168082526020829052604090912091929161038b90546001600160a01b031690565b906001600160a01b0382169081156104305750600080604051806103af818961028a565b0390845af4907fc4dabe0d7ef7462e2218f2c398c21ef217803e1c46f5cf802d1a5d1d9b503f2f6103de6102f5565b80966103ef60405192839283610320565b0390a2156103fa5750565b82519091501561040d5750805190602001fd5b60405163023c045d60e21b81526001600160a01b03919091166004820152602490fd5b60405163300eff3960e21b81523360048201526001600160e01b0319919091166024820152604490fd5b9091906001600160a01b037f000000000000000000000000000000000000000000000000000000000000000081169033821415806104ed575b6104c95750506104a5610309836102d9565b9180835236818501116100ff57602081600092610155968387013784010152610546565b606492604051926355d1750960e01b84526004840152336024840152166044820152fd5b5033600052600160205260ff6105198460406000209060018060a01b0316600052602052604060002090565b541615610493565b909161053861015593604084526040840190610104565b916020818403910152610104565b9190823b156105ce57600080825160208401865af4907fb24ebe141c5f2a744b103bea65fce6c40e0dc65d7341d092c09b160f404479906105856102f5565b60405190956001600160a01b03169281906105a290889083610521565b0390a2156105ac57565b508051156105bc57602081519101fd5b60405163061a160d60e41b8152600490fd5b604051636d17e5ef60e11b81526001600160a01b0384166004820152602490fd405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace";

    /*//////////////////////////////////////////////////////////////////////////
                                     DEPLOYERS
    //////////////////////////////////////////////////////////////////////////*/

    /// @notice Deploys {PRBProxyAnnex} from precompiled bytecode.
    function deployAnnex() public returns (IPRBProxyAnnex annex) {
        bytes memory bytecode = BYTECODE_ANNEX;
        assembly {
            annex := create(0, add(bytecode, 0x20), mload(bytecode))
        }
        require(address(annex) != address(0), "PRBProxy Precompiles: deployment failed for Annex contract");
    }

    /// @notice Deploys {PRBProxyRegistry} from precompiled bytecode.
    function deployRegistry() public returns (IPRBProxyRegistry registry) {
        bytes memory bytecode = BYTECODE_REGISTRY;
        assembly {
            registry := create(0, add(bytecode, 0x20), mload(bytecode))
        }
        require(address(registry) != address(0), "PRBProxy Precompiles: deployment failed for Registry contract");
    }

    /// @notice Deploys {PRBProxyAnnex} and {PRBProxyRegistry} from precompiled bytecode.
    function deploySystem() public returns (IPRBProxyAnnex annex, IPRBProxyRegistry registry) {
        annex = deployAnnex();
        registry = deployRegistry();
    }
}

// SPDX-License-Identifier: MIT
// solhint-disable max-line-length
pragma solidity >=0.8.18;

import { IPRBProxyAnnex } from "../../src/interfaces/IPRBProxyAnnex.sol";
import { IPRBProxyRegistry } from "../../src/interfaces/IPRBProxyRegistry.sol";

/// @notice This is useful for external integrations seeking to test against the exact deployed bytecode, as recompiling
/// with via IR enabled would be time-consuming.
contract Precompiles {
    /*//////////////////////////////////////////////////////////////////////////
                                     BYTECODES
    //////////////////////////////////////////////////////////////////////////*/

    bytes public constant BYTECODE_ANNEX =
        hex"6080806040523461001657610559908161001c8239f35b600080fdfe6080604081815260048036101561001557600080fd5b600092833560e01c9081631f9838b5146103ed5750806338a40908146103aa5780634bddd93a146102d55780638da5cb5b146102ad578063aa4b826a1461021d578063b9678403146101155763ffa1ad741461007057600080fd5b346101115782600319360112610111578151908282019082821067ffffffffffffffff8311176100fe57508252600c81526020906b342e302e302d626574612e3560a01b8282015282519382859384528251928382860152825b8481106100e857505050828201840152601f01601f19168101030190f35b81810183015188820188015287955082016100ca565b634e487b7160e01b855260419052602484fd5b8280fd5b503461011157602090816003193601126102195780356001600160a01b038116939084900361021557805163ecdb286560e01b81528581848183895af190811561020b5786916101e9575b5080519283156101d25750855b83811061019d5786867f88b2a910c369b31905e184140cbb1e5ec72817e11c4d6c5993f736716f8546598280a280f35b6001600160e01b03196101b0828461052f565b51168752600180865283882080546001600160a01b031916881790550161016d565b825163b702f33560e01b8152908101869052602490fd5b61020591503d8088833e6101fd818361046a565b8101906104a2565b38610160565b82513d88823e3d90fd5b8480fd5b8380fd5b5050346102a95760603660031901126102a957610238610439565b610240610454565b9160443590811515809203610215577f730824739164a9503317b3e878e816553b62d6763c1ba6df1390dea687e4d36c9160209160018060a01b038095169485885260028452818820961695868852835280872060ff1981541660ff841617905551908152a380f35b5080fd5b5050346102a957816003193601126102a957905490516001600160a01b039091168152602090f35b503461011157602090816003193601126102195780356001600160a01b038116939084900361021557805163ecdb286560e01b81528581848183895af190811561020b578691610390575b5080519283156101d25750855b83811061035d5786867f7207021e3ba5dd0d191feb5efcbb1a8dcf615fa597fc5e1a49ecc13c2b7dd92b8280a280f35b6001600160e01b0319610370828461052f565b51168752600180865283882080546001600160a01b03191690550161032d565b6103a491503d8088833e6101fd818361046a565b38610320565b5034610111576020366003190112610111573563ffffffff60e01b811680910361011157825260016020908152918190205490516001600160a01b039091168152f35b8490843461011157806003193601126101115760ff9060209361040e610439565b610416610454565b6001600160a01b0391821683526002875283832091168252855220541615158152f35b600435906001600160a01b038216820361044f57565b600080fd5b602435906001600160a01b038216820361044f57565b90601f8019910116810190811067ffffffffffffffff82111761048c57604052565b634e487b7160e01b600052604160045260246000fd5b90602090818382031261044f57825167ffffffffffffffff9384821161044f570181601f8201121561044f57805193841161048c578360051b90604051946104ec8584018761046a565b8552838086019282010192831161044f578301905b82821061050f575050505090565b81516001600160e01b03198116810361044f578152908301908301610501565b80518210156105435760209160051b010190565b634e487b7160e01b600052603260045260246000fd";

    bytes public constant BYTECODE_REGISTRY =
        hex"60808060405234610016576110a1908161001c8239f35b600080fdfe608080604052600436101561001357600080fd5b600090813560e01c908163092af813146103b0575080632c27a01f1461037857806374912cd214610308578063775c300c1461029c5780638fa3425c14610273578063c455279114610237578063f2fde38b146100f55763ffa1ad741461007957600080fd5b346100f257806003193601126100f257604051604081019080821067ffffffffffffffff8311176100dc576100d891604052600c81526b342e302e302d626574612e3560a01b6020820152604051918291602083526020830190610771565b0390f35b634e487b7160e01b600052604160045260246000fd5b80fd5b50346100f25760203660031901126100f25761010f610733565b6001600160a01b03818116808452600160205260408420549092908216908161020e575050338352600160205260408320541680156101f6573383526001602052604083206001600160601b0360a01b90818154169055828452816040852091825416179055803b156101f25760405163f2fde38b60e01b815260048101839052838160248183865af180156101e7576101d4575b506040519081527f6954f1cdad46901994f29d9b1f78744c873c527bad04d294b4954cc8caf367da60203392a380f35b6101e090939193610796565b91386101a4565b6040513d86823e3d90fd5b8280fd5b604051636b3d7d8760e01b8152336004820152602490fd5b6040516356352f0b60e11b81526001600160a01b03918216600482015291166024820152604490fd5b50346100f25760203660031901126100f2576020906001600160a01b039060409082610261610733565b16815260018452205416604051908152f35b50346100f257806003193601126100f2576002546040516001600160a01b039091168152602090f35b50346100f257806003193601126100f257338152600160205260409020546001600160a01b03908116806102df576020826102d6336107cc565b60405191168152f35b6040516356352f0b60e11b81523360048201526001600160a01b03919091166024820152604490fd5b50346100f25760203660031901126100f257604090610325610733565b6001600160a01b0380821683526001602052929091205482168061034f576020836102d6846107cc565b6040516356352f0b60e11b81526001600160a01b03928316600482015291166024820152604490fd5b50346100f25760203660031901126100f2576020906040906001600160a01b036103a0610733565b1681528083522054604051908152f35b82346100f25760403660031901126100f2576103ca610733565b9167ffffffffffffffff6024351161072f5736602360243501121561072f5767ffffffffffffffff602435600401351161072f57366024803560040135813501011161072f57338252600160205260408220546001600160a01b03168061070c5750503280825260208281526040808420548151928301938452908201819052919061046381606081015b03601f1981018352826107aa565b51902090306001600160601b0360a01b60025416176002556040516107ac8082019082821067ffffffffffffffff8311176106f85791809185936108f58339039085f5928315610638576001600160601b0360a01b6002541660025533815260016020526040812060018060a01b0385166001600160601b0360a01b8254161790553281528060205260018201604082205560405194631cff79cd60e01b865260018060a01b03166004860152604060248601526024356004013560448601526024356004013560248035016064870137606460243560040135868101820183905282918791601f19601f9091011682018290030181836001600160a01b0389165af19485156106eb578195610644575b506001600160a01b0384163b156100f25760405163f2fde38b60e01b8152336004820152908082602481836001600160a01b038a165af19081156106385750610629575b506040805191825260208201929092526001600160a01b038316918101919091523390819032907f6aafca263a35a9d2a6e4e4659a84688092f4ae153df2f95cd7659508d95c187090606090a46100d860405192839260018060a01b03168352604060208401526040830190610771565b61063290610796565b846105b8565b604051903d90823e3d90fd5b9094503d8086833e61065681836107aa565b8101906020818303126106e75780519067ffffffffffffffff82116106cf570181601f820112156106e757805167ffffffffffffffff81116106d357604051926106aa601f8301601f1916602001856107aa565b818452602082840101116106cf576106c8916020808501910161074e565b9385610574565b8680fd5b634e487b7160e01b87526041600452602487fd5b8580fd5b50604051903d90823e3d90fd5b634e487b7160e01b86526041600452602486fd5b6356352f0b60e11b82523360048301526001600160a01b03166024820152604490fd5b5080fd5b600435906001600160a01b038216820361074957565b600080fd5b60005b8381106107615750506000910152565b8181015183820152602001610751565b9060209161078a8151809281855285808601910161074e565b601f01601f1916010190565b67ffffffffffffffff81116100dc57604052565b90601f8019910116810190811067ffffffffffffffff8211176100dc57604052565b3260008181526020818152604080832054815192830194855282820181905294959492939092916108008160608101610455565b5190209160018060a01b03809616936001600160601b0360a01b968588600254161760025582516107ac8082019082821067ffffffffffffffff8311176108e05791809188936108f58339039084f580156108d657907f6aafca263a35a9d2a6e4e4659a84688092f4ae153df2f95cd7659508d95c1870939291169780600254166002558682526001602052888383209182541617905532815280602052816001850191205551806108d18833963296849192604091949360608401958452602084015260018060a01b0316910152565b0390a4565b83513d84823e3d90fd5b634e487b7160e01b85526041600452602485fdfe60a080604052346100ed57336080526323e8d09760e21b8152602081600481335afa9081156100e157600091610070575b50600080546001600160a01b0319166001600160a01b03929092169190911790556040516106b990816100f3823960805181818161022601526102a20152f35b60203d81116100da575b601f8101601f191682016001600160401b038111838210176100c6576020918391604052810103126100c25751906001600160a01b03821682036100bf575038610030565b80fd5b5080fd5b634e487b7160e01b84526041600452602484fd5b503d61007a565b6040513d6000823e3d90fd5b600080fdfe60806040526004361015610027575b36156100255761001d36610435565b602081519101f35b005b6000803560e01c9081631cff79cd1461008a575080631f9838b51461008557806338a40908146100805780637b1039991461007b5780638da5cb5b146100765763f2fde38b0361000e5761027e565b610255565b610210565b6101cb565b610168565b60403660031901126100f65761009e6100f9565b60243567ffffffffffffffff928382116100f657366023830112156100f65781600401359384116100f65736602485840101116100f6576100f26100e6856024850186610526565b60405191829182610154565b0390f35b80fd5b600435906001600160a01b038216820361010f57565b600080fd5b919082519283825260005b848110610140575050826000602080949584010152601f8019910116010190565b60208183018101518483018201520161011f565b906020610165928181520190610114565b90565b3461010f57604036600319011261010f576101816100f9565b602435906001600160a01b0390818316830361010f571660009081526002602090815260408083206001600160a01b03909416835292815291902060ff9054166040519015158152f35b3461010f57602036600319011261010f5760043563ffffffff60e01b811680910361010f576000526001602052602060018060a01b0360406000205416604051908152f35b3461010f57600036600319011261010f576040517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b3461010f57600036600319011261010f576000546040516001600160a01b039091168152602090f35b3461010f57602036600319011261010f576102976100f9565b6001600160a01b03907f000000000000000000000000000000000000000000000000000000000000000082163381036102e95750166bffffffffffffffffffffffff60a01b6000541617600055600080f35b6044906040519063124ad49160e11b82526004820152336024820152fd5b634e487b7160e01b600052604160045260246000fd5b6040519190601f01601f1916820167ffffffffffffffff81118382101761034357604052565b610307565b67ffffffffffffffff811161034357601f01601f191660200190565b91909161037861037382610348565b61031d565b92818452811161010f57602081600092838387013784010152565b9291926103a261037383610348565b938285528282011161010f57816000926020928387013784010152565b606090610165939260408252806040830152806000848401376000838284010152601f8019910116810190602083828403019101520190610114565b82610165949360609360408452816040850152848401376000838284010152601f8019910116810190602083828403019101520190610114565b600080356001600160e01b0319168082526001602052604090912091929161046490546001600160a01b031690565b6001600160a01b0381169182156104fc57506104896104833686610364565b83610645565b927fc4dabe0d7ef7462e2218f2c398c21ef217803e1c46f5cf802d1a5d1d9b503f2f8480976104bd604051928392836103bf565b0390a2156104c9575050565b8151156104d95750805190602001fd5b60405163023c045d60e21b81526001600160a01b03919091166004820152602490fd5b60405163300eff3960e21b81523360048201526001600160e01b0319919091166024820152604490fd5b6000549293926001600160a01b03929083163381141580610617575b6105e75750813b156105c6577fb24ebe141c5f2a744b103bea65fce6c40e0dc65d7341d092c09b160f4044799061058361057d368885610393565b84610645565b94909361059a8680996040519485941696846103fb565b0390a2156105a55750565b8051156105b457602081519101fd5b60405163061a160d60e41b8152600490fd5b604051636d17e5ef60e11b81526001600160a01b0383166004820152602490fd5b6040516355d1750960e01b81526001600160a01b0391821660048201523360248201529216604483015250606490fd5b503360009081526002602090815260408083206001600160a01b038716845290915290205460ff1615610542565b60008054835191946001600160a01b039490939185169286928392602001905af4923d156106b2573d61067a61037382610348565b9081523d86602083013e5b93945416808203610694575050565b604492506040519163609ca23d60e01b835260048301526024820152fd5b606061068556";

    /*//////////////////////////////////////////////////////////////////////////
                                     DEPLOYERS
    //////////////////////////////////////////////////////////////////////////*/

    /// @notice Deploys {PRBProxyAnnex} from precompiled bytecode.
    function deployAnnex() public returns (IPRBProxyAnnex annex) {
        bytes memory bytecode = BYTECODE_ANNEX;
        assembly {
            annex := create(0, add(bytecode, 0x20), mload(bytecode))
        }
        require(address(annex) != address(0), "PRBProxy Precompiles: deployment failed for Annex contract");
    }

    /// @notice Deploys {PRBProxyRegistry} from precompiled bytecode.
    function deployRegistry() public returns (IPRBProxyRegistry registry) {
        bytes memory bytecode = BYTECODE_REGISTRY;
        assembly {
            registry := create(0, add(bytecode, 0x20), mload(bytecode))
        }
        require(address(registry) != address(0), "PRBProxy Precompiles: deployment failed for Registry contract");
    }

    /// @notice Deploys {PRBProxyAnnex} and {PRBProxyRegistry} from precompiled bytecode.
    function deploySystem() public returns (IPRBProxyAnnex annex, IPRBProxyRegistry registry) {
        annex = deployAnnex();
        registry = deployRegistry();
    }
}
